- name: Collect student files older than X days
  hosts: "{{ target_host | default('all') }}"
  gather_facts: false

  vars:
    username: "student"             
    extensions: 'pdf,doc,docx,xls,xlsx,ppt,pptx'
    local_save_dir: "{{ destination_path | default('/home/subhash/Desktop/remote-files') }}"
    
    # ðŸ‘‡ YOU CAN CHANGE THIS VALUE DURING RUN
    age_in_days: "{{ file_age | default(1) }}" 
    # Example run: ansible-playbook collect.yml -e file_age=30

  tasks:   
    - name: Calculate reference date (X days ago)
      set_fact:
        target_date: "{{ lookup('pipe', 'date -d \"-' ~ age_in_days ~ ' days\" +%Y-%m-%d') }}"
      delegate_to: localhost
      run_once: true

    - name: Debug reference date
      debug:
        msg: "Collecting files created on or before: {{ target_date }}"

    - name: Get user profile path on remote host
      win_shell: |
        $user = "{{ username }}"
        (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\*").ProfileImagePath |
        Where-Object { $_ -like "*\$user" }
      register: user_profile_raw

    - name: Set user_profile fact
      set_fact:
        user_profile: "{{ user_profile_raw.stdout | trim }}"

    - name: Define target paths dynamically
      set_fact:
        target_paths:
          - "{{ user_profile }}\\Desktop"
          - "{{ user_profile }}\\Downloads"
          - "{{ user_profile }}\\Documents"

    - name: Find files older than X days
      win_shell: |
        $ref = Get-Date "{{ target_date }}"
        Get-ChildItem -Path "{{ item }}" -Recurse -Include *.{{ extensions | replace(',', ',*.') }} -ErrorAction SilentlyContinue |
        Where-Object { $_.CreationTime.Date -le $ref.Date } |
        Select-Object -ExpandProperty FullName
      loop: "{{ target_paths }}"
      register: matched_files

    - name: Flatten list of all matched files
      set_fact:
        all_matched_files: "{{ matched_files.results | map(attribute='stdout_lines') | list | flatten }}"

    - name: Ensure destination directory exists on control node
      ansible.builtin.file:
        path: "{{ local_save_dir }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: Show matched files
      debug:
        var: all_matched_files

    - name: Fetch files to control node
      ansible.builtin.fetch:
        src: "{{ item }}"
        dest: "{{ local_save_dir }}/{{ inventory_hostname }}/"
        flat: yes
      loop: "{{ all_matched_files }}"
      when: item is defined and item != ''
